generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ORG_ADMIN
  AGENT
  ANALYST
  OPS
  VIEWER
}

enum DocumentType {
  FACILITY_AGREEMENT
  AMENDMENT
  OTHER
}

enum CovenantTestStatus {
  PASS
  WARN
  FAIL
}

enum ScenarioMode {
  BASE
  STRESS
}

enum CovenantMetric {
  DSCR
  LIQUIDITY
  LEVERAGE
  EBITDA
  INTEREST_COVER
}

enum CovenantOperator {
  GTE
  LTE
}

enum TradingItemStatus {
  OPEN
  DONE
  BLOCKED
}

enum ReadinessBand {
  RED
  AMBER
  GREEN
}

enum ESGKpiType {
  EMISSIONS_SCOPE_1
  EMISSIONS_SCOPE_2
  EMISSIONS_SCOPE_3
  RENEWABLE_ENERGY_PERCENT
  ENERGY_INTENSITY
  WATER_USAGE
  WASTE_RECYCLED_PERCENT
  SAFETY_TRIR
  DIVERSITY_PERCENT
  OTHER
}

enum ESGEvidenceType {
  REPORT
  CERTIFICATE
  INVOICE
  AUDIT
  POLICY
  OTHER
}

enum ESGVerificationStatus {
  PENDING
  VERIFIED
  NEEDS_REVIEW
  REJECTED
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships                      Membership[]
  loans                            Loan[]
  auditEvents                      AuditEvent[]
  documents                        Document[]
  documentVersions                 DocumentVersion[]
  clauses                          Clause[]
  loanScenarios                    LoanScenario[]
  covenants                        Covenant[]
  covenantTestResults              CovenantTestResult[]
  tradingChecklistItems            TradingChecklistItem[]
  tradingReadinessSnapshots        TradingReadinessSnapshot[]
  tradingReadinessFactSnapshots    TradingReadinessFactSnapshot[]
  tradingReadinessExplanations     TradingReadinessExplanation[]
  esgKpis                          ESGKpi[]
  esgEvidence                      ESGEvidence[]
  esgVerifications                 ESGVerification[]
  esgKpiFactSnapshots              EsgKpiFactSnapshot[]
  esgKpiExplanations               EsgKpiExplanation[]
  covenantEvaluationFactSnapshots  CovenantEvaluationFactSnapshot[]
  covenantExplanations             CovenantExplanation[]
  portfolioRiskFactSnapshots       PortfolioRiskFactSnapshot[]
  portfolioRiskExplanations        PortfolioRiskExplanation[]
}

model User {
  id        String   @id @default(cuid())
  email     String?  @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]
  auditEvents AuditEvent[] @relation("AuditActor")
}

model Membership {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  role      UserRole @default(VIEWER)
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
}

model Loan {
  id             String   @id @default(cuid())
  tenantId       String
  borrower       String
  agentBank      String
  currency       String
  facilityAmount BigInt
  marginBps      Int
  status         String
  lastUpdatedAt  DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  documents                        Document[]
  scenario                         LoanScenario?
  covenants                        Covenant[]
  covenantTestResults              CovenantTestResult[]
  tradingChecklistItems            TradingChecklistItem[]
  tradingReadinessSnapshots        TradingReadinessSnapshot[]
  tradingReadinessFactSnapshots    TradingReadinessFactSnapshot[]
  tradingReadinessExplanations     TradingReadinessExplanation[]
  esgKpis                          ESGKpi[]
  esgEvidence                      ESGEvidence[]
  esgVerifications                 ESGVerification[]
  esgKpiFactSnapshots              EsgKpiFactSnapshot[]
  esgKpiExplanations               EsgKpiExplanation[]
  covenantEvaluationFactSnapshots  CovenantEvaluationFactSnapshot[]
  covenantExplanations             CovenantExplanation[]

  @@unique([tenantId, id])
  @@index([tenantId])
}

enum ActorType {
  USER
  SERVICE
}

model AuditEvent {
  id            String     @id @default(cuid())
  tenantId      String
  
  // Actor Identity (compliance-grade)
  actorId       String?    // FK to User table (null for SERVICE or deleted users)
  actorType     ActorType? // USER or SERVICE (null for legacy events)
  actorUserId   String?    // Denormalized user ID (preserved even if user deleted)
  actorClientId String?    // Client ID for SERVICE actions (e.g., 'lexa-ledger-worker')
  actorRoles    String[]   @default([]) // Role snapshot at time of action
  
  // Request Context (forensic traceability)
  correlationId String?    // Request/job correlation ID for tracing
  ip            String?    // Client IP address (web requests only)
  userAgent     String?    // User agent string (web requests only)
  
  // Event Data
  type          String
  summary       String
  evidenceRef   String?
  payload       Json?
  createdAt     DateTime   @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor  User?  @relation("AuditActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([actorId])
  @@index([actorType])
  @@index([correlationId])
  @@index([createdAt])
}

model Document {
  id        String       @id @default(cuid())
  tenantId  String
  loanId    String
  type      DocumentType @default(OTHER)
  title     String
  createdAt DateTime     @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  versions DocumentVersion[]

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([loanId])
}

model DocumentVersion {
  id          String   @id @default(cuid())
  tenantId    String
  documentId  String
  version     Int
  fileKey     String
  fileName    String
  contentType String
  checksum    String?
  uploadedAt  DateTime @default(now())

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  clauses Clause[]

  @@unique([tenantId, id])
  @@unique([documentId, version])
  @@index([tenantId])
}

model Clause {
  id                String   @id @default(cuid())
  tenantId          String
  documentVersionId String
  clauseRef         String?
  title             String?
  text              String
  riskTags          String[] // Postgres text[]
  extractedAt       DateTime @default(now())

  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documentVersion DocumentVersion @relation(fields: [documentVersionId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([documentVersionId])
}

model LoanScenario {
  id        String       @id @default(cuid())
  tenantId  String
  loanId    String       @unique
  mode      ScenarioMode @default(BASE)
  updatedAt DateTime     @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId])
}

model Covenant {
  id          String   @id @default(cuid())
  tenantId    String
  loanId      String
  code        String // e.g. "DSCR_MIN"
  title       String // "Debt Service Coverage Ratio"
  description String?
  threshold   Float // numeric threshold used by rule
  unit        String? // e.g. "x", "%", "USD"
  createdAt   DateTime @default(now())

  // NEW: explicit rule definition
  metric   CovenantMetric
  operator CovenantOperator @default(GTE)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  results CovenantTestResult[]

  @@unique([tenantId, id])
  @@unique([tenantId, loanId, code])
  @@index([tenantId])
  @@index([loanId])
}

model CovenantTestResult {
  id         String         @id @default(cuid())
  tenantId   String
  loanId     String
  covenantId String
  scenario   ScenarioMode
  value      Float
  status     CovenantTestStatus
  testedAt   DateTime       @default(now())
  notes      String?

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan     Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  covenant Covenant @relation(fields: [covenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([loanId])
  @@index([covenantId])
  @@index([scenario])
}

model TradingChecklistItem {
  id       String @id @default(cuid())
  tenantId String
  loanId   String

  code        String // e.g. "DOCS.FACILITY_AGREEMENT"
  title       String // e.g. "Facility Agreement uploaded"
  description String?
  category    String // e.g. "DOCUMENTS", "SERVICING", "ESG", "KYC"
  weight      Int               @default(10) // points contributing to score
  status      TradingItemStatus @default(OPEN)

  evidenceRef String? // e.g. documentVersionId, clauseId, etc.
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@unique([tenantId, loanId, code])
  @@index([tenantId])
  @@index([loanId])
  @@index([status])
  @@index([category])
}

model TradingReadinessSnapshot {
  id       String @id @default(cuid())
  tenantId String
  loanId   String

  score      Int // 0..100
  band       ReadinessBand
  reasons    Json? // explainability for UI (v1 can store counts/notes)
  computedAt DateTime      @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([loanId])
  @@index([computedAt])
}

// Week 3 - Track A.1: Explainable Trading Readiness
// Immutable fact snapshot for AI explainability (deterministic, versioned, auditable)
model TradingReadinessFactSnapshot {
  id       String @id @default(cuid())
  tenantId String
  loanId   String

  // Core readiness metrics (from deterministic engine)
  readinessScore Int // 0..100
  readinessBand  ReadinessBand // GREEN / AMBER / RED

  // Contributing factors (deterministic calculations)
  contributingFactors Json // { documentationCompleteness: 0.92, covenantCompliance: true, ... }

  // Blocking issues (array of human-readable strings)
  blockingIssues Json // ["Missing executed Amendment #3", ...]

  // Metadata (immutability contract)
  factVersion Int      @default(1) // For schema evolution
  computedAt  DateTime @default(now())
  computedBy  String   @default("SYSTEM") // USER or SYSTEM

  // Hash for audit verification (prevents tampering)
  factHash String @unique // SHA256 of deterministic fields

  // Audit correlation
  correlationId String?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([loanId])
  @@index([computedAt])
  @@index([readinessBand])
  @@index([tenantId, loanId, computedAt])
}

// Week 3 - Track A.1: AI-generated explanations (cached, immutable)
model TradingReadinessExplanation {
  id            String   @id @default(cuid())
  tenantId      String
  loanId        String

  factHash      String   // Links to TradingReadinessFactSnapshot by hash

  // Cache key fields
  audience      String   // TRADING_ANALYST | TRADING_VIEWER | INVESTOR | COMPLIANCE
  verbosity     String   // SHORT | STANDARD | DETAILED

  explainVersion Int     @default(1)
  provider      String   // demo | openai | anthropic | etc

  // Explanation payload (UI-ready, stored as single JSON blob)
  result        Json

  // Integrity / deduplication
  explanationHash String @unique

  // Traceability
  createdAt     DateTime @default(now())
  correlationId String?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([loanId])
  @@index([factHash])
  @@index([tenantId, loanId, factHash, createdAt])
}

model ESGKpi {
  id       String @id @default(cuid())
  tenantId String
  loanId   String

  type     ESGKpiType
  title    String
  unit     String? // "tCO2e", "%", "kWh", etc.
  target   Float?
  current  Float?
  asOfDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  evidence ESGEvidence[]

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([loanId])
  @@index([type])
}

model ESGEvidence {
  id       String  @id @default(cuid())
  tenantId String
  loanId   String
  kpiId    String?

  type        ESGEvidenceType @default(OTHER)
  title       String
  source      String? // "Borrower", "Auditor", "Utility Provider", etc.
  periodStart DateTime?
  periodEnd   DateTime?

  fileKey     String // MinIO key
  fileName    String
  contentType String
  checksum    String?

  uploadedAt DateTime @default(now())

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan    @relation(fields: [loanId], references: [id], onDelete: Cascade)
  kpi    ESGKpi? @relation(fields: [kpiId], references: [id], onDelete: SetNull)

  verifications ESGVerification[]

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([loanId])
  @@index([kpiId])
  @@index([uploadedAt])
}

model ESGVerification {
  id         String @id @default(cuid())
  tenantId   String
  loanId     String
  evidenceId String

  status     ESGVerificationStatus @default(PENDING)
  confidence Float? // 0..1
  notes      String? // human/worker explanation
  checkedAt  DateTime              @default(now())

  tenant   Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan     Loan        @relation(fields: [loanId], references: [id], onDelete: Cascade)
  evidence ESGEvidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([loanId])
  @@index([evidenceId])
  @@index([status])
}

// Week 3 - Track A: Explainable Intelligence
// ESG KPI Fact Snapshots (deterministic evaluation outputs)
model EsgKpiFactSnapshot {
  id            String       @id @default(cuid())
  tenantId      String
  loanId        String
  kpiId         String
  kpiCode       String
  kpiName       String

  // Deterministic evaluation outputs
  status        EsgKpiStatus
  score         Int?
  reasonCodes   Json

  // Evidence + provenance (facts only)
  measurement   Json
  evidence      Json
  verification  Json
  sources       Json

  computedAt    DateTime @default(now())
  computedBy    String
  factVersion   Int      @default(1)
  factHash      String   @unique
  correlationId String?

  tenant       Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan         Loan                @relation(fields: [loanId], references: [id], onDelete: Cascade)
  explanations EsgKpiExplanation[]

  @@index([tenantId, loanId, kpiId, computedAt])
}

// ESG KPI Explanations (cached AI explanations)
model EsgKpiExplanation {
  id              String   @id @default(cuid())
  tenantId        String
  loanId          String
  kpiId           String
  factHash        String

  audience        String
  verbosity       String
  explainVersion  Int      @default(1)
  provider        String
  result          Json
  explanationHash String   @unique

  createdAt       DateTime @default(now())
  correlationId   String?

  tenant       Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan         Loan               @relation(fields: [loanId], references: [id], onDelete: Cascade)
  factSnapshot EsgKpiFactSnapshot @relation(fields: [factHash], references: [factHash], onDelete: Cascade)

  @@index([tenantId, loanId, kpiId, factHash, createdAt])
}

enum EsgKpiStatus {
  PASS
  FAIL
  NEEDS_VERIFICATION
  UNKNOWN
}

// Week 3 - Track A: Explainable Intelligence
// Covenant Evaluation Fact Snapshots (deterministic covenant assessments)
model CovenantEvaluationFactSnapshot {
  id            String   @id @default(cuid())
  tenantId      String
  loanId        String
  covenantId    String
  covenantName  String
  covenantType  String

  // Deterministic evaluation outputs
  status        CovenantStatus
  threshold     Json
  observed      Json
  breachDetail  Json

  // Inputs used (facts only)
  inputSignals  Json
  sourceRefs    Json

  computedAt    DateTime @default(now())
  computedBy    String
  factVersion   Int      @default(1)
  factHash      String   @unique
  correlationId String?

  tenant       Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan         Loan                  @relation(fields: [loanId], references: [id], onDelete: Cascade)
  explanations CovenantExplanation[]

  @@index([tenantId, loanId, covenantId, computedAt])
}

// Covenant Explanations (cached AI explanations)
model CovenantExplanation {
  id              String   @id @default(cuid())
  tenantId        String
  loanId          String
  covenantId      String
  factHash        String

  audience        String
  verbosity       String
  explainVersion  Int      @default(1)
  provider        String
  result          Json
  explanationHash String   @unique

  createdAt       DateTime @default(now())
  correlationId   String?

  tenant       Tenant                           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan         Loan                             @relation(fields: [loanId], references: [id], onDelete: Cascade)
  factSnapshot CovenantEvaluationFactSnapshot   @relation(fields: [factHash], references: [factHash], onDelete: Cascade)

  @@index([tenantId, loanId, covenantId, factHash, createdAt])
}

enum CovenantStatus {
  COMPLIANT
  BREACH
  AT_RISK
  UNKNOWN
}

// Week 3 - Track A: Portfolio-level Intelligence
// Portfolio Risk Fact Snapshots (deterministic aggregates)
model PortfolioRiskFactSnapshot {
  id            String   @id @default(cuid())
  tenantId      String
  portfolioId   String?
  asOfDate      DateTime

  // Deterministic aggregates
  totals        Json
  distributions Json
  topDrivers    Json
  anomalies     Json

  computedAt    DateTime @default(now())
  computedBy    String
  factVersion   Int      @default(1)
  factHash      String   @unique
  correlationId String?

  tenant       Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  explanations PortfolioRiskExplanation[]

  @@index([tenantId, asOfDate, computedAt])
}

// Portfolio Risk Explanations (cached AI explanations)
model PortfolioRiskExplanation {
  id              String   @id @default(cuid())
  tenantId        String
  portfolioId     String?
  factHash        String

  audience        String
  verbosity       String
  explainVersion  Int      @default(1)
  provider        String
  result          Json
  explanationHash String   @unique

  createdAt       DateTime @default(now())
  correlationId   String?

  tenant       Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  factSnapshot PortfolioRiskFactSnapshot  @relation(fields: [factHash], references: [factHash], onDelete: Cascade)

  @@index([tenantId, portfolioId, factHash, createdAt])
}

// ============================================================================
// Impact Detection (Week 3 - Track C Step C2)
// ============================================================================

// Impact Event
// 
// Records when a source change (Document/Amendment) affects downstream facts.
// Enables audit trail of change propagation and impact graph visualization.
// 
// Flow:
// 1. Source changes (Document updated)
// 2. ImpactService detects affected targets
// 3. ImpactEvent persisted (audit trail)
// 4. Recompute jobs enqueued for targets
// 5. Drift detection â†’ explanation recompute (Track B)
model ImpactEvent {
  id            String   @id @default(cuid())
  tenantId      String
  correlationId String?
  
  // Source (what changed)
  sourceType    String   // DOCUMENT | AMENDMENT
  sourceId      String
  sourceAction  String   // CREATED | UPDATED | DELETED
  
  // Detected impacts (JSON payload for flexibility)
  // Structure: { source, loanId, targets: [...], reasonCodes: [...] }
  impacts       Json
  
  detectedAt    DateTime @default(now())

  @@index([tenantId, detectedAt])
  @@index([tenantId, sourceType, sourceId])
  @@index([correlationId])
}
