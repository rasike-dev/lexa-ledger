generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ORG_ADMIN
  AGENT
  ANALYST
  OPS
  VIEWER
}

enum DocumentType {
  FACILITY_AGREEMENT
  AMENDMENT
  OTHER
}

enum CovenantStatus {
  PASS
  WARN
  FAIL
}

enum ScenarioMode {
  BASE
  STRESS
}

enum CovenantMetric {
  DSCR
  LIQUIDITY
  LEVERAGE
  EBITDA
  INTEREST_COVER
}

enum CovenantOperator {
  GTE
  LTE
}

enum TradingItemStatus {
  OPEN
  DONE
  BLOCKED
}

enum ReadinessBand {
  RED
  AMBER
  GREEN
}

enum ESGKpiType {
  EMISSIONS_SCOPE_1
  EMISSIONS_SCOPE_2
  EMISSIONS_SCOPE_3
  RENEWABLE_ENERGY_PERCENT
  ENERGY_INTENSITY
  WATER_USAGE
  WASTE_RECYCLED_PERCENT
  SAFETY_TRIR
  DIVERSITY_PERCENT
  OTHER
}

enum ESGEvidenceType {
  REPORT
  CERTIFICATE
  INVOICE
  AUDIT
  POLICY
  OTHER
}

enum ESGVerificationStatus {
  PENDING
  VERIFIED
  NEEDS_REVIEW
  REJECTED
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships               Membership[]
  loans                     Loan[]
  auditEvents               AuditEvent[]
  documents                 Document[]
  documentVersions          DocumentVersion[]
  clauses                   Clause[]
  loanScenarios             LoanScenario[]
  covenants                 Covenant[]
  covenantTestResults       CovenantTestResult[]
  tradingChecklistItems     TradingChecklistItem[]
  tradingReadinessSnapshots TradingReadinessSnapshot[]
  esgKpis                   ESGKpi[]
  esgEvidence               ESGEvidence[]
  esgVerifications          ESGVerification[]
}

model User {
  id        String   @id @default(cuid())
  email     String?  @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]
  auditEvents AuditEvent[] @relation("AuditActor")
}

model Membership {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  role      UserRole @default(VIEWER)
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
}

model Loan {
  id             String   @id @default(cuid())
  tenantId       String
  borrower       String
  agentBank      String
  currency       String
  facilityAmount BigInt
  marginBps      Int
  status         String
  lastUpdatedAt  DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  documents                 Document[]
  scenario                  LoanScenario?
  covenants                 Covenant[]
  covenantTestResults       CovenantTestResult[]
  tradingChecklistItems     TradingChecklistItem[]
  tradingReadinessSnapshots TradingReadinessSnapshot[]
  esgKpis                   ESGKpi[]
  esgEvidence               ESGEvidence[]
  esgVerifications          ESGVerification[]

  @@unique([tenantId, id])
  @@index([tenantId])
}

enum ActorType {
  USER
  SERVICE
}

model AuditEvent {
  id            String     @id @default(cuid())
  tenantId      String
  
  // Actor Identity (compliance-grade)
  actorId       String?    // FK to User table (null for SERVICE or deleted users)
  actorType     ActorType? // USER or SERVICE (null for legacy events)
  actorUserId   String?    // Denormalized user ID (preserved even if user deleted)
  actorClientId String?    // Client ID for SERVICE actions (e.g., 'lexa-ledger-worker')
  actorRoles    String[]   @default([]) // Role snapshot at time of action
  
  // Request Context (forensic traceability)
  correlationId String?    // Request/job correlation ID for tracing
  ip            String?    // Client IP address (web requests only)
  userAgent     String?    // User agent string (web requests only)
  
  // Event Data
  type          String
  summary       String
  evidenceRef   String?
  payload       Json?
  createdAt     DateTime   @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor  User?  @relation("AuditActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([actorId])
  @@index([actorType])
  @@index([correlationId])
  @@index([createdAt])
}

model Document {
  id        String       @id @default(cuid())
  tenantId  String
  loanId    String
  type      DocumentType @default(OTHER)
  title     String
  createdAt DateTime     @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  versions DocumentVersion[]

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([loanId])
}

model DocumentVersion {
  id          String   @id @default(cuid())
  tenantId    String
  documentId  String
  version     Int
  fileKey     String
  fileName    String
  contentType String
  checksum    String?
  uploadedAt  DateTime @default(now())

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  clauses Clause[]

  @@unique([tenantId, id])
  @@unique([documentId, version])
  @@index([tenantId])
}

model Clause {
  id                String   @id @default(cuid())
  tenantId          String
  documentVersionId String
  clauseRef         String?
  title             String?
  text              String
  riskTags          String[] // Postgres text[]
  extractedAt       DateTime @default(now())

  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documentVersion DocumentVersion @relation(fields: [documentVersionId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([documentVersionId])
}

model LoanScenario {
  id        String       @id @default(cuid())
  tenantId  String
  loanId    String       @unique
  mode      ScenarioMode @default(BASE)
  updatedAt DateTime     @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId])
}

model Covenant {
  id          String   @id @default(cuid())
  tenantId    String
  loanId      String
  code        String // e.g. "DSCR_MIN"
  title       String // "Debt Service Coverage Ratio"
  description String?
  threshold   Float // numeric threshold used by rule
  unit        String? // e.g. "x", "%", "USD"
  createdAt   DateTime @default(now())

  // NEW: explicit rule definition
  metric   CovenantMetric
  operator CovenantOperator @default(GTE)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  results CovenantTestResult[]

  @@unique([tenantId, id])
  @@unique([tenantId, loanId, code])
  @@index([tenantId])
  @@index([loanId])
}

model CovenantTestResult {
  id         String         @id @default(cuid())
  tenantId   String
  loanId     String
  covenantId String
  scenario   ScenarioMode
  value      Float
  status     CovenantStatus
  testedAt   DateTime       @default(now())
  notes      String?

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan     Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  covenant Covenant @relation(fields: [covenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([loanId])
  @@index([covenantId])
  @@index([scenario])
}

model TradingChecklistItem {
  id       String @id @default(cuid())
  tenantId String
  loanId   String

  code        String // e.g. "DOCS.FACILITY_AGREEMENT"
  title       String // e.g. "Facility Agreement uploaded"
  description String?
  category    String // e.g. "DOCUMENTS", "SERVICING", "ESG", "KYC"
  weight      Int               @default(10) // points contributing to score
  status      TradingItemStatus @default(OPEN)

  evidenceRef String? // e.g. documentVersionId, clauseId, etc.
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@unique([tenantId, loanId, code])
  @@index([tenantId])
  @@index([loanId])
  @@index([status])
  @@index([category])
}

model TradingReadinessSnapshot {
  id       String @id @default(cuid())
  tenantId String
  loanId   String

  score      Int // 0..100
  band       ReadinessBand
  reasons    Json? // explainability for UI (v1 can store counts/notes)
  computedAt DateTime      @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([loanId])
  @@index([computedAt])
}

model ESGKpi {
  id       String @id @default(cuid())
  tenantId String
  loanId   String

  type     ESGKpiType
  title    String
  unit     String? // "tCO2e", "%", "kWh", etc.
  target   Float?
  current  Float?
  asOfDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  evidence ESGEvidence[]

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([loanId])
  @@index([type])
}

model ESGEvidence {
  id       String  @id @default(cuid())
  tenantId String
  loanId   String
  kpiId    String?

  type        ESGEvidenceType @default(OTHER)
  title       String
  source      String? // "Borrower", "Auditor", "Utility Provider", etc.
  periodStart DateTime?
  periodEnd   DateTime?

  fileKey     String // MinIO key
  fileName    String
  contentType String
  checksum    String?

  uploadedAt DateTime @default(now())

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan   Loan    @relation(fields: [loanId], references: [id], onDelete: Cascade)
  kpi    ESGKpi? @relation(fields: [kpiId], references: [id], onDelete: SetNull)

  verifications ESGVerification[]

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([loanId])
  @@index([kpiId])
  @@index([uploadedAt])
}

model ESGVerification {
  id         String @id @default(cuid())
  tenantId   String
  loanId     String
  evidenceId String

  status     ESGVerificationStatus @default(PENDING)
  confidence Float? // 0..1
  notes      String? // human/worker explanation
  checkedAt  DateTime              @default(now())

  tenant   Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  loan     Loan        @relation(fields: [loanId], references: [id], onDelete: Cascade)
  evidence ESGEvidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([loanId])
  @@index([evidenceId])
  @@index([status])
}
